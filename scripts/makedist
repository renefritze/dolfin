#!/bin/bash
#
# Copyright (C) Anders Logg 2002-2008
# Licensed under the GNU LGPL Version 2.1
#
# This script creates a new release of DOLFIN

# Make sure we have the current version
echo '--- Synchronizing repository'
sleep 1
hg commit
hg pull http://www.fenics.org/hg/dolfin
hg merge
hg commit
hg update
hg push ssh://dolfin@fenics.org/hg/dolfin

# Update version numbers
echo '--- Update version number in ChangeLog'
sleep 1
emacs -nw ChangeLog
echo '--- Update version number in SConstruct'
sleep 1
emacs -nw SConstruct
echo '--- Update version number in dolfin/scons.cfg'
sleep 1
emacs -nw dolfin/scons.cfg
echo '--- Update version number in __init__.py'
sleep 1
emacs -nw site-packages/dolfin/__init__.py

# Get the version number
VERSION=`head -1 ChangeLog | cut -d' ' -f1`
echo "--- Version number is $VERSION"

# Tag repository
hg tag $VERSION

# Commit changes to hg
echo '--- Pushing changes to parent repository'
sleep 1
hg commit
hg push ssh://dolfin@fenics.org/hg/dolfin

# Create archive
echo "--- Creating release $VERSION of DOLFIN"
hg archive -t tgz dolfin-$VERSION.tar.gz

# Copy files to web server
echo '--- Copying files to web server'
scp dolfin-$VERSION.tar.gz fenics@fenics.org:www.fenics.org/pub/software/dolfin/v0.9
scp ChangeLog fenics@fenics.org:www.fenics.org/pub/software/dolfin
scp TODO fenics@fenics.org:www.fenics.org/pub/software/dolfin

# Notify dolfin-dev of the new version
echo '--- Notifying mailing list'
SUBJECT="Version "$VERSION" of DOLFIN released"
cat ChangeLog | mail -s "$SUBJECT" dolfin-dev@fenics.org

# Edit web pages
echo '--- Edit web pages'
ssh -t fenics@fenics.org '/home/fenics/local/bin/news'
firefox http://www.fenics.org/wiki/Download
firefox http://freshmeat.net/projects/dolfin/
