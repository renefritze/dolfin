__author__ = "Marie E. Rognes (meg@simula.no)"
__copyright__ = "Copyright (C) 2011 Marie Rognes"
__license__  = "GNU LGPL version 3 or any later version"

# Based on original implementation by Martin Alnes and Anders Logg

# Last changed: 2011-01-19

import includes as incl
from functionspace import *
from form import generate_form

parameters = {"use_common_coefficient_names": True}

def generate_dolfin_code(prefix, header, forms, add_guards=False):
    """Generate complete dolfin wrapper code with given generated names.

    @param prefix:
        String, prefix for all form names.
    @param header:
        Code that will be inserted at the top of the file.
    @param form_names:
        List of UFCFormNames instances for each form to wrap.
    @param common_space:
        Tuple (form_index, space_index) of common function space if
        any, otherwise None.
    @param add_guards:
        True iff guards (ifdefs) should be added
    """

    # Generate dolfin namespace
    namespace = generate_dolfin_namespace(prefix, forms)

    # Collect pieces of code
    code = [incl.dolfin_tag, header, incl.stl_includes, incl.dolfin_includes,
            namespace]

    # Add ifdefs/endifs if specified
    if add_guards:
        guard_name = ("%s_h" % prefix).upper()
        preguard = "#ifndef %s\n#define %s\n" % (guard_name, guard_name)
        postguard = "\n#endif\n\n"
        code = [preguard] + code + [postguard]

    # Return code
    return "\n".join(code)

def generate_dolfin_namespace(prefix, forms):

    # Extract (common) coefficient spaces
    assert(parameters["use_common_coefficient_names"])
    spaces = extract_coefficient_spaces(forms)

    # Generate code for common coefficient spaces
    code = [generate_functionspace_class(*space) for space in spaces]

    # Generate code for forms
    code += [generate_form(form, "Form_%d"%i) for (i, form) in enumerate(forms)]

    # Generate namespace typedefs (Bilinear/Linear & Test/TrialFunctionSpace)
    code += [generate_namespace_typedefs(forms)]

    # Wrap code in namespace block
    code = "\nnamespace %s\n{\n\n%s\n}" % (prefix, "\n".join(code))

    # Return code
    return code

def generate_namespace_typedefs(forms):

    typedefs = ["// Class typedefs"] # Marie says: Why "Class"?

    # Add typedef for BilinearForm is there is only one present
    bilinears = [i for (i, form) in enumerate(forms) if form.rank == 2]
    if len(bilinears) == 1:
        typedefs += ["typedef Form_%d BilinearForm;" % bilinears[0]]

    # Add typedef for LinearForm is there is only one present
    linears = [i for (i, form) in enumerate(forms) if form.rank == 1]
    if len(linears) == 1:
        typedefs += ["typedef Form_%d LinearForm;" % linears[0]]

    # FIXME: Add global TestSpace/TrialSpace/FunctionSpace typedefs

    return "\n".join(typedefs)
